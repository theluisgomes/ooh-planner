<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OOH Planner - Planejadora de M√≠dia Out-of-Home</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.png" alt="Logo OOH Planner" class="logo-icon"
                        style="width: 50px; height: 50px; border-radius: 100%;">
                    <div>
                        <h1>O Botic√°rio</h1>
                        <p class="subtitle">OOH PLANNER - DATA-FLOW V2.1</p>
                    </div>
                </div>

                <div class="header-actions">
                    <button class="btn btn-secondary" id="btnHelp"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
                        ‚ùì Guia R√°pido
                    </button>
                    <a href="history.html" class="btn btn-secondary"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem; text-decoration: none; display: inline-flex; align-items: center;">
                        üìú Hist√≥rico
                    </a>
                    <button class="btn btn-secondary" id="btnSavePlan"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
                        üíæ Salvar Plano
                    </button>
                    <button class="btn btn-secondary" id="btnLogout" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                        üö™ Sair
                    </button>
                </div>

                <div class="total-card">
                    <div class="total-label">BUDGET L√çQUIDO ATUAL</div>
                    <div class="total-value" id="totalCard">R$ 0,00</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Blocos de M√≠dia -->
    <main class="main-content">
        <div class="container">
            <div id="mediaBlocks" class="media-blocks-grid">
                <!-- Blocos gerados dinamicamente -->
            </div>

            <div class="actions-bar" style="text-align: center; margin: 2rem 0;">
                <button id="btnAddBlock" class="btn btn-primary" onclick="addBlock()">
                    + ADICIONAR RECORTE DE M√çDIA
                </button>
            </div>
        </div>
    </main>

    <!-- Global Analytics Dashboard -->
    <section id="globalDashboard" style="display: none;">
        <div class="container">
            <div class="charts-section">
                <h4 class="section-title">üìä An√°lise Global / Share</h4>

                <!-- KPI stat cards -->
                <div class="kpi-cards-row">
                    <div class="kpi-card accent-blue">
                        <span class="kpi-card-label">Total de Faces</span>
                        <span class="kpi-card-value" id="gKpiFaces">--</span>
                        <span class="kpi-card-sub">faces negociadas</span>
                    </div>
                    <div class="kpi-card accent-green">
                        <span class="kpi-card-label">Investimento Total</span>
                        <span class="kpi-card-value" id="gKpiInvest">--</span>
                        <span class="kpi-card-sub">custo negociado</span>
                    </div>
                    <div class="kpi-card accent-teal">
                        <span class="kpi-card-label">CPF M√©dio</span>
                        <span class="kpi-card-value" id="gKpiCpf">--</span>
                        <span class="kpi-card-sub">custo por face</span>
                    </div>
                    <div class="kpi-card accent-purple">
                        <span class="kpi-card-label">Recortes Ativos</span>
                        <span class="kpi-card-value" id="gKpiRecortes">--</span>
                        <span class="kpi-card-sub">blocos de m√≠dia</span>
                    </div>
                </div>

                <!-- charts row: donut + donut + bar -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <span class="chart-card-title">Share por Formato</span>
                        <div class="chart-canvas-wrap">
                            <canvas id="gChartFormato"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <span class="chart-card-title">Share por Exibidor</span>
                        <div class="chart-canvas-wrap">
                            <canvas id="gChartExibidor"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <span class="chart-card-title">Investimento por Formato (R$)</span>
                        <div class="chart-canvas-wrap">
                            <canvas id="gChartBarFormato"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mapa Geogr√°fico -->
    <section class="map-section" id="mapSection" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2>üó∫Ô∏è Distribui√ß√£o Geogr√°fica</h2>
            </div>
            <div id="mapContainer" style="height: 400px; border-radius: 12px; overflow: hidden;"></div>
        </div>
    </section>

    <!-- Tabela Consolidada -->
    <section class="consolidated-section">
        <div class="container">
            <div class="section-header">
                <h2>üìã Tabela Consolidada</h2>
                <div class="section-actions">
                    <button class="btn btn-secondary" id="btnResetAll">üîÑ Reset Tudo</button>
                    <button class="btn btn-primary" id="btnExport">üì• Exportar CSV</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="consolidated-table" id="consolidatedTable">
                    <thead>
                        <tr>
                            <th>M√≠dia</th>
                            <th>Pra√ßa</th>
                            <th>Taxonomia</th>
                            <th>Budget</th>
                            <th>Formatos</th>
                            <th>TT Faces</th>
                            <th>Budget Ideal</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="consolidatedTableBody">
                        <tr class="empty-state">
                            <td colspan="8">Nenhuma m√≠dia configurada ainda</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Template do Bloco de M√≠dia -->
    <template id="mediaBlockTemplate">
        <div class="media-block">
            <div class="media-block-header">
                <div class="media-number">
                    <span class="number-badge">1</span>
                    <div>
                        <h3>RECORTE DE M√çDIA</h3>
                        <p class="config-label">CONFIGURA√á√ÉO T√âCNICA #01</p>
                    </div>
                </div>
                <div class="media-status">
                    <span class="status-badge inactive">INATIVO</span>
                    <button class="btn-icon btn-delete" title="Resetar bloco">üóëÔ∏è</button>
                </div>
            </div>

            <div class="media-block-content">
                <!-- CORE INPUTS -->
                <div class="core-inputs-section">
                    <h4 class="section-title">üìù Par√¢metros Principais</h4>
                    <div class="core-inputs-grid">
                        <div class="form-group">
                            <label>üí∞ BUDGET (R$)</label>
                            <input type="number" class="form-control input-budget" placeholder="Ex: 100000" min="0"
                                step="1000">
                        </div>

                        <div class="form-group">
                            <label>üìç PRA√áA</label>
                            <select class="form-control input-praca">
                                <option value="">Selecione...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>üè∑Ô∏è TAXONOMIA</label>
                            <select class="form-control input-taxonomia">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- PLANNING TABLE -->
                <div class="planning-section" style="display: none;">
                    <h4 class="section-title">üìä PLANEJAMENTO</h4>
                    <div class="planning-table-wrapper">
                        <table class="planning-table">
                            <thead>
                                <tr class="planning-header-main">
                                    <th rowspan="2">VE√çCULO</th>
                                    <th rowspan="2">FORMATO</th>
                                    <th rowspan="2">TT FACES</th>
                                    <th rowspan="2">INDEX</th>
                                    <th rowspan="2" colspan="2">TIPO MATERIAL</th>
                                    <th colspan="4" class="weeks-header">SEMANAS</th>
                                    <th rowspan="2">TABELA UNIT.</th>
                                    <th rowspan="2">TOTAL LINHA</th>
                                    <th rowspan="2">NEGOCIA√á√ÉO</th>
                                    <th rowspan="2">TT NEG.</th>
                                    <th rowspan="2">BUDGET IDEAL</th>
                                    <th rowspan="2">CUSTO/FACE</th>
                                    <th rowspan="2">OBS</th>
                                </tr>
                                <tr class="planning-header-weeks">
                                    <th>S1</th>
                                    <th>S2</th>
                                    <th>S3</th>
                                    <th>S4</th>
                                </tr>
                            </thead>
                            <tbody class="planning-body">
                                <!-- Populated dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="planning-totals">
                                    <td colspan="2"><strong>TOTAIS</strong></td>
                                    <td class="total-faces">--</td>
                                    <td class="total-index">--</td>
                                    <td colspan="2"></td>
                                    <td class="total-s1">--</td>
                                    <td class="total-s2">--</td>
                                    <td class="total-s3">--</td>
                                    <td class="total-s4">--</td>
                                    <td class="total-tabela">--</td>
                                    <td class="total-linha">--</td>
                                    <td></td>
                                    <td class="total-neg">--</td>
                                    <td class="total-budget-ideal">--</td>
                                    <td class="total-custo-face">--</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- EXPOSI√á√ÉO + EFICI√äNCIA GAUGES -->
                <div class="gauges-section" style="display: none;">
                    <div class="gauges-grid">
                        <!-- EXPOSI√á√ÉO -->
                        <div class="gauge-card">
                            <h4 class="gauge-title">EXPOSI√á√ÉO</h4>
                            <table class="gauge-table">
                                <thead>
                                    <tr>
                                        <th>Min</th>
                                        <th>Index</th>
                                        <th>Max</th>
                                        <th>Index</th>
                                        <th>Median</th>
                                    </tr>
                                </thead>
                                <tbody class="exposure-table-body">
                                    <!-- Populated dynamically -->
                                </tbody>
                                <tfoot>
                                    <tr class="gauge-totals">
                                        <td class="exp-total-min">--</td>
                                        <td></td>
                                        <td class="exp-total-max">--</td>
                                        <td></td>
                                        <td class="exp-total-median">--</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="gauge-slider-container">
                                <div class="gauge-slider-value exp-gauge-value">--</div>
                                <div class="slider-track">
                                    <div class="slider-dashed-line"></div>
                                    <div class="slider-cursor baseline" style="left: 50%;"></div>
                                    <div class="slider-cursor current exposure-cursor" style="left: 0%;"></div>
                                </div>
                                <div class="slider-labels">
                                    <span>UNDER</span>
                                    <span>OVER</span>
                                </div>
                            </div>
                        </div>

                        <!-- EFICI√äNCIA R$ -->
                        <div class="gauge-card">
                            <h4 class="gauge-title">EFICI√äNCIA R$</h4>
                            <table class="gauge-table">
                                <thead>
                                    <tr>
                                        <th>CPF MIN</th>
                                        <th>CPF MAX</th>
                                    </tr>
                                </thead>
                                <tbody class="efficiency-table-body">
                                    <!-- Populated dynamically -->
                                </tbody>
                                <tfoot>
                                    <tr class="gauge-totals">
                                        <td class="eff-total-min">--</td>
                                        <td class="eff-total-max">--</td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="gauge-slider-container">
                                <div class="gauge-slider-value eff-gauge-value">--</div>
                                <div class="slider-track">
                                    <div class="slider-dashed-line"></div>
                                    <div class="slider-cursor baseline" style="left: 50%;"></div>
                                    <div class="slider-cursor current efficiency-cursor" style="left: 0%;"></div>
                                </div>
                                <div class="slider-labels">
                                    <span>INEFICIENTE</span>
                                    <span>EFICIENTE</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensagem de erro/aviso -->
                <div class="block-message" style="display: none;"></div>
            </div>
        </div>
    </template>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ùì Guia R√°pido de Uso</h2>
                <button class="modal-close" id="helpModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <h3>1. Configure o recorte de m√≠dia</h3>
                <p>Preencha os tr√™s par√¢metros do bloco na seguinte ordem:</p>
                <ul>
                    <li><strong>Budget (R$):</strong> defina o or√ßamento dispon√≠vel para o recorte.</li>
                    <li><strong>Pra√ßa:</strong> selecione a cidade ou regi√£o do plano.</li>
                    <li><strong>Taxonomia:</strong> escolha o tipo de produto/campanha.</li>
                </ul>
                <p>Ao preencher os tr√™s campos, o planejamento ser√° carregado automaticamente.</p>

                <h3>2. Ajuste as quantidades (S1‚ÄìS4)</h3>
                <p>Na tabela de planejamento, preencha as quantidades de faces por semana.
                    Cada campo mostra o <strong>m√°ximo permitido</strong> (total de faces dispon√≠veis).</p>
                <p>‚ö†Ô∏è Se o valor digitado ultrapassar o m√°ximo, o campo ficar√° destacado em vermelho como alerta.</p>

                <h3>3. Interprete os resultados</h3>
                <ul>
                    <li><strong>Indicadores (gauges):</strong> exposi√ß√£o e efici√™ncia or√ßament√°ria em tempo real.</li>
                    <li><strong>Gr√°ficos de share:</strong> distribui√ß√£o do investimento por formato e por exibidor.
                    </li>
                    <li><strong>Mapa geogr√°fico:</strong> visualize a distribui√ß√£o do investimento por pra√ßa.</li>
                    <li><strong>Tabela consolidada:</strong> resumo geral com todas as m√≠dias configuradas.</li>
                </ul>

                <h3>4. Exporte e compartilhe</h3>
                <p>Use o bot√£o <strong>Exportar CSV</strong> para baixar a tabela e usar como base para decks ou
                    negocia√ß√µes.</p>
                <p>Para salvar o plano completo, use o bot√£o <strong>Salvar Plano</strong> no cabe√ßalho.</p>

                <h3>üí° Boas pr√°ticas</h3>
                <ul>
                    <li>Sempre preencha Budget, Pra√ßa e Taxonomia antes de editar quantidades.</li>
                    <li>Use "+ ADICIONAR RECORTE DE M√çDIA" para comparar cen√°rios lado a lado.</li>
                    <li>Se um alerta aparecer, avalie o ajuste de ambi√ß√£o ‚Äî n√£o √© um bug.</li>
                    <li>Consulte o mapa e os gr√°ficos para validar a distribui√ß√£o do investimento.</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        document.getElementById('btnLogout').addEventListener('click', async () => {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    alert('Erro ao sair. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                alert('Erro de conex√£o ao tentar sair.');
            }
        });
    </script>
</body>

</html>